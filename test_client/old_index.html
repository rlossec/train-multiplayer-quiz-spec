<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test WebSocket - Train Multiplayer Game</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .form-group {
        margin: 15px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      button[type="button"] {
        background-color: #28a745;
        margin-left: 5px;
        padding: 5px 10px;
        font-size: 12px;
      }
      button[type="button"]:hover {
        background-color: #218838;
      }
      label {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        font-weight: bold;
        cursor: pointer;
      }
      input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
      }
      .messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f8f9fa;
        margin: 10px 0;
      }
      .message {
        margin: 5px 0;
        padding: 5px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 12px;
        line-height: 1.4;
      }
      .message.sent {
        background-color: #e3f2fd;
        margin-left: auto;
        max-width: 80%;
      }
      .message.received {
        background-color: #f3e5f5;
        max-width: 80%;
      }
      .message.error {
        background-color: #ffebee;
        color: #c62828;
        max-width: 80%;
      }
      .message-container {
        position: relative;
        margin: 5px 0;
        display: flex;
        flex-direction: column;
      }
      .message-container.sent {
        align-items: flex-end;
      }
      .message-container.received {
        align-items: flex-start;
      }
      .message-container.error {
        align-items: flex-start;
      }
      .copy-btn {
        position: absolute;
        top: 5px;
        background: rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 3px;
        padding: 2px 6px;
        cursor: pointer;
        font-size: 12px;
        opacity: 0.7;
        transition: opacity 0.2s;
        z-index: 10;
      }
      .message-container.sent .copy-btn {
        right: 5px;
      }
      .message-container.received .copy-btn {
        right: 5px;
      }
      .message-container.error .copy-btn {
        right: 5px;
      }
      .copy-btn:hover {
        opacity: 1;
        background: rgba(0, 0, 0, 0.2);
      }
      .timestamp {
        font-size: 10px;
        color: #666;
        margin-bottom: 2px;
        font-weight: bold;
      }
      .message-container.sent .timestamp {
        text-align: right;
      }
      .message-container.received .timestamp {
        text-align: left;
      }
      .message-container.error .timestamp {
        text-align: left;
      }
      .lobby-list {
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        max-height: 300px;
        overflow-y: auto;
      }
      .lobby-item {
        padding: 8px;
        margin: 5px 0;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .lobby-info {
        flex: 1;
      }
      .lobby-code {
        font-weight: bold;
        color: #007bff;
        font-size: 1.1em;
      }
      .lobby-details {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 2px;
      }
      .lobby-players {
        font-size: 0.8em;
        color: #28a745;
        margin-top: 2px;
      }
      .lobby-status {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: bold;
      }
      .status-waiting {
        background-color: #fff3cd;
        color: #856404;
      }
      .status-playing {
        background-color: #d1ecf1;
        color: #0c5460;
      }
      .status-finished {
        background-color: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Test WebSocket - Train Multiplayer Game</h1>

      <h3>‚öôÔ∏è Configuration</h3>
      <div class="form-group">
        <label for="websocketUrl">URL WebSocket:</label>
        <input
          type="text"
          id="websocketUrl"
          value=""
          placeholder="ws://localhost:8000/game/ws"
        />
      </div>
      <div class="form-group">
        <label for="httpBaseUrl">URL HTTP Base:</label>
        <input
          type="text"
          id="httpBaseUrl"
          value=""
          placeholder="http://localhost:8000"
        />
      </div>
      <button onclick="updateConfig()" type="button">
        üîÑ Mettre √† jour la configuration
      </button>

      <hr />

      <div class="form-group">
        <label for="socketId">Socket ID:</label>
        <input
          type="text"
          id="socketId"
          value=""
          placeholder="Entrez un ID unique"
        />
        <button onclick="generateNewSocketId()" type="button">
          üîÑ Nouveau ID
        </button>
      </div>

      <div class="form-group">
        <button id="connectBtn" onclick="connect()">Se connecter</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          Se d√©connecter
        </button>
        <button onclick="ping()" disabled id="pingBtn">Ping</button>
      </div>

      <hr />

      <h3>üìã Liste des Lobbies</h3>
      <div class="form-group">
        <button onclick="fetchLobbyList()" class="btn btn-primary">
          üîç R√©cup√©rer la liste des lobbies
        </button>
      </div>
      <div id="lobbyList" class="lobby-list"></div>

      <h3>Cr√©er un Lobby</h3>
      <div class="form-group">
        <label for="lobbyName">Nom du lobby:</label>
        <input type="text" id="lobbyName" value="" placeholder="Nom du lobby" />
      </div>
      <div class="form-group">
        <label for="ownerName">Nom du propri√©taire:</label>
        <input type="text" id="ownerName" value="" placeholder="Votre nom" />
      </div>
      <div class="form-group">
        <label for="ownerColor">Couleur:</label>
        <select id="ownerColor">
          <option value="red">Rouge</option>
          <option value="blue">Bleu</option>
          <option value="green">Vert</option>
          <option value="yellow">Jaune</option>
        </select>
      </div>
      <div class="form-group">
        <label for="maxPlayersCreate">Nombre max de joueurs:</label>
        <input type="number" id="maxPlayersCreate" value="" min="2" max="10" />
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="adminIsPlayer" checked />
          L'admin est un joueur actif
        </label>
      </div>
      <button onclick="createLobby()" disabled id="createBtn">
        Cr√©er un Lobby
      </button>

      <hr />

      <h3>Rejoindre un Lobby</h3>
      <div class="form-group">
        <label for="lobbyCode">Code du Lobby:</label>
        <input
          type="text"
          id="lobbyCode"
          placeholder="Entrez le code du lobby"
        />
      </div>
      <div class="form-group">
        <label for="playerName">Nom du joueur:</label>
        <input type="text" id="playerName" value="" placeholder="Votre nom" />
      </div>
      <div class="form-group">
        <label for="playerColor">Couleur:</label>
        <select id="playerColor">
          <option value="red">Rouge</option>
          <option value="blue">Bleu</option>
          <option value="green">Vert</option>
          <option value="yellow">Jaune</option>
        </select>
      </div>
      <button onclick="joinLobby()" disabled id="joinBtn">
        Rejoindre le Lobby
      </button>

      <hr />

      <h3>Actions</h3>
      <button onclick="startGame()" disabled id="startBtn">
        D√©marrer la Partie
      </button>

      <hr />

      <h3>üéÆ Zone de Jeu</h3>
      <div id="gameSection" style="display: none">
        <div class="form-group">
          <label for="buzzAnswer">Ma r√©ponse:</label>
          <input
            type="text"
            id="buzzAnswer"
            placeholder="Tapez votre r√©ponse ici..."
          />
        </div>
        <div class="form-group">
          <label for="timeToAnswer">Temps de r√©ponse (secondes):</label>
          <input
            type="number"
            id="timeToAnswer"
            value="0"
            min="0"
            step="0.1"
            placeholder="Temps en secondes"
          />
        </div>
        <button onclick="sendBuzz()" disabled id="buzzBtn">üö® BUZZ !</button>
      </div>

      <hr />

      <h3>üëë Gestion Admin</h3>
      <div id="adminSection" style="display: none">
        <div class="form-group">
          <label for="questionNumber">Num√©ro de question:</label>
          <input
            type="number"
            id="questionNumber"
            value="1"
            min="1"
            placeholder="Num√©ro de question"
          />
        </div>
        <button onclick="closeQuestion()" disabled id="closeQuestionBtn">
          üîí Fermer la Question
        </button>
        <button onclick="nextQuestion()" disabled id="nextQuestionBtn">
          ‚û°Ô∏è Question Suivante
        </button>
        <button onclick="endGame()" disabled id="endGameBtn">
          üèÅ Terminer la Partie
        </button>
      </div>

      <hr />

      <h3>Messages</h3>
      <div id="messages" class="messages"></div>
      <button onclick="clearMessages()">Effacer les messages</button>
      <button onclick="copyAllMessages()">üìã Copier tous les messages</button>
    </div>

    <script>
      // ========================================
      // CONFIGURATION - Modifiez ces valeurs selon votre environnement
      // ========================================
      const CONFIG = {
        // URLs du serveur
        WEBSOCKET_URL: "ws://localhost:8000/game/ws",
        HTTP_BASE_URL: "http://localhost:8000",

        // Param√®tres de connexion
        DEFAULT_SOCKET_ID_PREFIX: "user-",
        SOCKET_ID_LENGTH: 9,

        // Param√®tres de jeu par d√©faut
        DEFAULT_LOBBY_NAME: "Mon Lobby",
        DEFAULT_OWNER_NAME: "Admin",
        DEFAULT_PLAYER_NAME: "Joueur",
        DEFAULT_MAX_PLAYERS: 4,
        DEFAULT_ADMIN_IS_PLAYER: true,

        // Param√®tres d'affichage
        MESSAGE_REFRESH_INTERVAL: 100, // ms pour le chronom√®tre
        COPY_BUTTON_TIMEOUT: 1000, // ms pour l'affichage du checkmark

        // Couleurs disponibles
        AVAILABLE_COLORS: [
          { value: "red", label: "Rouge" },
          { value: "blue", label: "Bleu" },
          { value: "green", label: "Vert" },
          { value: "yellow", label: "Jaune" },
          { value: "purple", label: "Violet" },
          { value: "orange", label: "Orange" },
          { value: "pink", label: "Rose" },
          { value: "cyan", label: "Cyan" },
        ],
      };

      // ========================================
      // FONCTIONS D'INITIALISATION
      // ========================================

      function updateConfig() {
        // Mettre √† jour la configuration avec les valeurs des champs
        const websocketUrl = document.getElementById("websocketUrl").value;
        const httpBaseUrl = document.getElementById("httpBaseUrl").value;

        if (websocketUrl) {
          CONFIG.WEBSOCKET_URL = websocketUrl;
        }
        if (httpBaseUrl) {
          CONFIG.HTTP_BASE_URL = httpBaseUrl;
        }

        addMessage("Configuration mise √† jour", "received");
        console.log("Configuration mise √† jour:", CONFIG);
      }

      function initializeDefaultValues() {
        // Initialiser les valeurs par d√©faut des champs
        document.getElementById("websocketUrl").value = CONFIG.WEBSOCKET_URL;
        document.getElementById("httpBaseUrl").value = CONFIG.HTTP_BASE_URL;
        document.getElementById("lobbyName").value = CONFIG.DEFAULT_LOBBY_NAME;
        document.getElementById("ownerName").value = CONFIG.DEFAULT_OWNER_NAME;
        document.getElementById("playerName").value =
          CONFIG.DEFAULT_PLAYER_NAME;
        document.getElementById("maxPlayersCreate").value =
          CONFIG.DEFAULT_MAX_PLAYERS;
        document.getElementById("adminIsPlayer").checked =
          CONFIG.DEFAULT_ADMIN_IS_PLAYER;

        // G√©n√©rer un Socket ID al√©atoire
        generateNewSocketId();
      }

      function updateColorOptions() {
        // Mettre √† jour les options de couleurs pour le propri√©taire
        const ownerColorSelect = document.getElementById("ownerColor");
        ownerColorSelect.innerHTML = CONFIG.AVAILABLE_COLORS.map(
          (color) => `<option value="${color.value}">${color.label}</option>`
        ).join("");

        // Mettre √† jour les options de couleurs pour le joueur
        const playerColorSelect = document.getElementById("playerColor");
        playerColorSelect.innerHTML = CONFIG.AVAILABLE_COLORS.map(
          (color) => `<option value="${color.value}">${color.label}</option>`
        ).join("");
      }

      // ========================================
      // VARIABLES GLOBALES
      // ========================================
      let ws = null;
      let isConnected = false;
      let isAdmin = false;
      let isPlayer = false;
      let gameStarted = false;
      let currentLobby = null;
      let gameTimer = null;
      let gameStartTime = null;
      let hasBuzz = false; // Track si le joueur a d√©j√† buzz√© pour cette question

      function updateStatus(connected) {
        isConnected = connected;
        const statusEl = document.getElementById("status");
        const connectBtn = document.getElementById("connectBtn");
        const disconnectBtn = document.getElementById("disconnectBtn");
        const pingBtn = document.getElementById("pingBtn");
        const createBtn = document.getElementById("createBtn");
        const joinBtn = document.getElementById("joinBtn");
        const startBtn = document.getElementById("startBtn");
        const buzzBtn = document.getElementById("buzzBtn");
        const closeQuestionBtn = document.getElementById("closeQuestionBtn");
        const nextQuestionBtn = document.getElementById("nextQuestionBtn");
        const endGameBtn = document.getElementById("endGameBtn");

        if (connected) {
          statusEl.textContent = "Connect√©";
          statusEl.className = "status connected";
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          pingBtn.disabled = false;
          createBtn.disabled = false;
          joinBtn.disabled = false;
          startBtn.disabled = false;
          updateGameButtons();
        } else {
          statusEl.textContent = "D√©connect√©";
          statusEl.className = "status disconnected";
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          pingBtn.disabled = true;
          createBtn.disabled = true;
          joinBtn.disabled = true;
          startBtn.disabled = true;
          hideGameSections();
        }
      }

      function updateGameButtons() {
        const buzzBtn = document.getElementById("buzzBtn");
        const closeQuestionBtn = document.getElementById("closeQuestionBtn");
        const nextQuestionBtn = document.getElementById("nextQuestionBtn");
        const endGameBtn = document.getElementById("endGameBtn");

        // Activer les boutons selon le r√¥le et l'√©tat du jeu
        if (isPlayer && gameStarted) {
          if (hasBuzz) {
            buzzBtn.disabled = true;
            buzzBtn.textContent = "‚úÖ BUZZ ENVOY√â !";
            buzzBtn.style.backgroundColor = "#28a745";
            buzzBtn.style.color = "white";
            // Afficher le temps final dans le champ
            const timeField = document.getElementById("timeToAnswer");
            timeField.style.backgroundColor = "#d4edda";
            timeField.style.color = "#155724";
            timeField.style.fontWeight = "bold";
          } else {
            buzzBtn.disabled = false;
            buzzBtn.textContent = "üö® BUZZ !";
            buzzBtn.style.backgroundColor = "#dc3545";
            buzzBtn.style.color = "white";
            // Remettre le champ de temps normal
            const timeField = document.getElementById("timeToAnswer");
            timeField.style.backgroundColor = "";
            timeField.style.color = "";
            timeField.style.fontWeight = "";
          }
        } else {
          buzzBtn.disabled = true;
          buzzBtn.textContent = "üö® BUZZ !";
          buzzBtn.style.backgroundColor = "#6c757d";
          buzzBtn.style.color = "white";
        }

        closeQuestionBtn.disabled = !(isAdmin && gameStarted);
        nextQuestionBtn.disabled = !(isAdmin && gameStarted);
        endGameBtn.disabled = !(isAdmin && gameStarted);
      }

      function showGameSections() {
        const gameSection = document.getElementById("gameSection");
        const adminSection = document.getElementById("adminSection");

        if (isPlayer) {
          gameSection.style.display = "block";
        }
        if (isAdmin) {
          adminSection.style.display = "block";
        }
      }

      function hideGameSections() {
        const gameSection = document.getElementById("gameSection");
        const adminSection = document.getElementById("adminSection");

        gameSection.style.display = "none";
        adminSection.style.display = "none";

        // R√©initialiser les √©tats
        isAdmin = false;
        isPlayer = false;
        gameStarted = false;
        currentLobby = null;
      }

      function addMessage(message, type = "received") {
        const messagesEl = document.getElementById("messages");
        const messageContainer = document.createElement("div");
        messageContainer.className = `message-container ${type}`;

        const messageEl = document.createElement("div");
        messageEl.className = `message ${type}`;

        // Formater le JSON avec indentation
        let formattedMessage;
        if (typeof message === "string") {
          formattedMessage = message;
        } else {
          formattedMessage = JSON.stringify(message, null, 2);
        }

        // Ajouter un timestamp
        const timestamp = new Date().toLocaleTimeString();
        const timestampEl = document.createElement("div");
        timestampEl.className = "timestamp";
        timestampEl.textContent = `[${timestamp}]`;

        messageEl.textContent = formattedMessage;

        // Ajouter un bouton de copie
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "üìã";
        copyBtn.className = "copy-btn";
        copyBtn.title = "Copier le message";
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(formattedMessage).then(() => {
            copyBtn.textContent = "‚úÖ";
            setTimeout(() => {
              copyBtn.textContent = "üìã";
            }, CONFIG.COPY_BUTTON_TIMEOUT);
          });
        };

        messageContainer.appendChild(timestampEl);
        messageContainer.appendChild(messageEl);
        messageContainer.appendChild(copyBtn);
        messagesEl.appendChild(messageContainer);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function connect() {
        const socketId = document.getElementById("socketId").value;
        if (!socketId) {
          alert("Veuillez entrer un Socket ID");
          return;
        }

        ws = new WebSocket(`${CONFIG.WEBSOCKET_URL}/${socketId}`);

        ws.onopen = function (event) {
          updateStatus(true);
          addMessage("Connexion √©tablie", "sent");
        };

        ws.onmessage = function (event) {
          const message = JSON.parse(event.data);
          addMessage(message, "received");

          // Traitement des messages sp√©ciaux
          if (message.type === "lobby_created") {
            document.getElementById("lobbyCode").value =
              message.data.lobby_code;
            currentLobby = message.data.lobby;
            isAdmin = true;
            isPlayer =
              message.data.lobby.players[
                document.getElementById("socketId").value
              ] !== undefined;
            showGameSections();
          } else if (message.type === "lobby_joined") {
            currentLobby = message.data.lobby;
            // V√©rifier si on est admin
            isAdmin =
              message.data.lobby.admin ===
              document.getElementById("socketId").value;
            // V√©rifier si on est joueur (pr√©sent dans la liste des joueurs)
            isPlayer =
              message.data.lobby.players[
                document.getElementById("socketId").value
              ] !== undefined;
            showGameSections();
          } else if (message.type === "game_started") {
            gameStarted = true;
            currentLobby = message.data.lobby;
            // R√©activer le buzz au d√©but de la partie
            hasBuzz = false;
            updateGameButtons();
            addMessage(
              "üéÆ Partie d√©marr√©e ! Vous pouvez maintenant jouer.",
              "received"
            );
            if (isPlayer) {
              startGameTimer();
            }
          } else if (message.type === "buzz_received") {
            addMessage(
              `üö® Buzz re√ßu de ${message.data.buzz.user.name} !`,
              "received"
            );
          } else if (message.type === "question_closed") {
            addMessage("üîí Question ferm√©e ! Scores mis √† jour.", "received");
            updateGameButtons();
            if (isPlayer) {
              stopGameTimer();
            }
          } else if (message.type === "next_question") {
            addMessage(
              `‚û°Ô∏è Question ${message.data.questionNumber}`,
              "received"
            );
            // R√©activer le buzz pour la nouvelle question
            hasBuzz = false;
            updateGameButtons();
            if (isPlayer) {
              resetGameTimer();
              startGameTimer();
            }
          } else if (message.type === "game_ended") {
            gameStarted = false;
            addMessage("üèÅ Partie termin√©e !", "received");
            updateGameButtons();
            if (isPlayer) {
              stopGameTimer();
            }
          }
        };

        ws.onclose = function (event) {
          updateStatus(false);
          addMessage("Connexion ferm√©e", "sent");
        };

        ws.onerror = function (error) {
          addMessage(`Erreur: ${error}`, "error");
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      function ping() {
        if (ws && isConnected) {
          ws.send(JSON.stringify({ type: "ping" }));
          addMessage({ type: "ping" }, "sent");
        }
      }

      function createLobby() {
        if (ws && isConnected) {
          const data = {
            type: "create_lobby",
            data: {
              lobbyName: document.getElementById("lobbyName").value,
              ownerName: document.getElementById("ownerName").value,
              ownerColor: document.getElementById("ownerColor").value,
              maxPlayers: parseInt(
                document.getElementById("maxPlayersCreate").value
              ),
              adminIsPlayer: document.getElementById("adminIsPlayer").checked,
            },
          };
          ws.send(JSON.stringify(data));
          addMessage(data, "sent");
        }
      }

      function joinLobby() {
        if (ws && isConnected) {
          const data = {
            type: "join_lobby",
            data: {
              lobbyCode: document.getElementById("lobbyCode").value,
              playerName: document.getElementById("playerName").value,
              playerColor: document.getElementById("playerColor").value,
            },
          };
          ws.send(JSON.stringify(data));
          addMessage(data, "sent");
        }
      }

      function startGame() {
        if (ws && isConnected) {
          const data = { type: "start_game" };
          ws.send(JSON.stringify(data));
          addMessage(data, "sent");
        }
      }

      function sendBuzz() {
        if (ws && isConnected && isPlayer && gameStarted && !hasBuzz) {
          const answer = document.getElementById("buzzAnswer").value;
          const timeToAnswer = parseFloat(
            document.getElementById("timeToAnswer").value
          );

          if (!answer.trim()) {
            alert("Veuillez entrer une r√©ponse !");
            return;
          }

          const data = {
            type: "buzz",
            data: {
              answer: answer,
              timeToAnswer: timeToAnswer,
            },
          };
          ws.send(JSON.stringify(data));
          addMessage(data, "sent");

          // Arr√™ter le chronom√®tre pour capturer le temps exact
          stopGameTimer();
          addMessage(`‚è±Ô∏è Chronom√®tre arr√™t√© √† ${timeToAnswer}s`, "sent");

          // Marquer que le joueur a buzz√©
          hasBuzz = true;
          updateGameButtons();

          // Vider le champ de r√©ponse
          document.getElementById("buzzAnswer").value = "";
        }
      }

      function closeQuestion() {
        if (ws && isConnected && isAdmin && gameStarted) {
          const data = { type: "close_question" };
          ws.send(JSON.stringify(data));
          addMessage(data, "sent");
        }
      }

      function nextQuestion() {
        if (ws && isConnected && isAdmin && gameStarted) {
          const questionNumber = parseInt(
            document.getElementById("questionNumber").value
          );
          const data = {
            type: "next_question",
            data: {
              questionNumber: questionNumber,
            },
          };
          ws.send(JSON.stringify(data));
          addMessage(data, "sent");
        }
      }

      function endGame() {
        if (ws && isConnected && isAdmin) {
          const data = {
            type: "end_game",
            data: {
              reason: "manual",
            },
          };
          ws.send(JSON.stringify(data));
          addMessage(data, "sent");
        }
      }

      function startGameTimer() {
        gameStartTime = Date.now();
        gameTimer = setInterval(() => {
          const elapsed = (Date.now() - gameStartTime) / 1000;
          document.getElementById("timeToAnswer").value = elapsed.toFixed(1);
        }, CONFIG.MESSAGE_REFRESH_INTERVAL);
      }

      function stopGameTimer() {
        if (gameTimer) {
          clearInterval(gameTimer);
          gameTimer = null;
        }
        // Marquer visuellement que le temps est arr√™t√©
        const timeField = document.getElementById("timeToAnswer");
        timeField.style.backgroundColor = "#fff3cd";
        timeField.style.color = "#856404";
        timeField.style.fontWeight = "bold";
        timeField.title = "Temps fig√© apr√®s le buzz";
      }

      function resetGameTimer() {
        stopGameTimer();
        document.getElementById("timeToAnswer").value = "0";
        gameStartTime = null;
        // Remettre le champ de temps √† son √©tat normal
        const timeField = document.getElementById("timeToAnswer");
        timeField.style.backgroundColor = "";
        timeField.style.color = "";
        timeField.style.fontWeight = "";
        timeField.title = "";
      }

      function clearMessages() {
        document.getElementById("messages").innerHTML = "";
      }

      function copyAllMessages() {
        const messagesEl = document.getElementById("messages");
        const messageContainers =
          messagesEl.querySelectorAll(".message-container");
        let allMessages = "";

        messageContainers.forEach((container, index) => {
          const timestampEl = container.querySelector(".timestamp");
          const messageEl = container.querySelector(".message");
          const timestamp = timestampEl
            ? timestampEl.textContent
            : "[Sans heure]";

          const type = messageEl.classList.contains("sent")
            ? "[ENVOY√â]"
            : messageEl.classList.contains("received")
            ? "[RE√áU]"
            : messageEl.classList.contains("error")
            ? "[ERREUR]"
            : "[AUTRE]";

          allMessages += `${timestamp} ${type} Message ${index + 1}:\n${
            messageEl.textContent
          }\n\n`;
        });

        navigator.clipboard.writeText(allMessages).then(() => {
          alert("Tous les messages ont √©t√© copi√©s dans le presse-papiers !");
        });
      }

      // Fonction pour r√©cup√©rer la liste des lobbies
      async function fetchLobbyList() {
        try {
          const response = await fetch(`${CONFIG.HTTP_BASE_URL}/lobby_list`);
          const data = await response.json();

          if (data.success) {
            displayLobbyList(data.lobbies);
            addMessage(
              `Liste des lobbies r√©cup√©r√©e: ${data.total} lobby(s) trouv√©(s)`,
              "received"
            );
          } else {
            addMessage(
              `Erreur lors de la r√©cup√©ration des lobbies: ${
                data.error || "Erreur inconnue"
              }`,
              "error"
            );
          }
        } catch (error) {
          addMessage(
            `Erreur lors de la r√©cup√©ration des lobbies: ${error.message}`,
            "error"
          );
        }
      }

      // Fonction pour afficher la liste des lobbies
      function displayLobbyList(lobbies) {
        const lobbyListDiv = document.getElementById("lobbyList");

        if (lobbies.length === 0) {
          lobbyListDiv.innerHTML =
            '<p style="text-align: center; color: #6c757d; font-style: italic;">Aucun lobby disponible</p>';
          return;
        }

        lobbyListDiv.innerHTML = lobbies
          .map((lobby) => {
            const statusClass = `status-${lobby.status}`;
            const playersList = lobby.players
              .map(
                (player) =>
                  `<span style="color: ${player.color}; font-weight: bold;">${player.name}</span> (${player.score} pts)`
              )
              .join(", ");

            return `
            <div class="lobby-item">
              <div class="lobby-info">
                <div class="lobby-code">${lobby.code}</div>
                <div class="lobby-details">${lobby.name} ‚Ä¢ ${
              lobby.currentPlayers
            }/${lobby.maxPlayers} joueurs</div>
                <div class="lobby-players">Joueurs: ${
                  playersList || "Aucun"
                }</div>
              </div>
              <div class="lobby-status ${statusClass}">${lobby.status}</div>
            </div>
          `;
          })
          .join("");
      }

      function generateNewSocketId() {
        const newId =
          CONFIG.DEFAULT_SOCKET_ID_PREFIX +
          Math.random().toString(36).substr(2, CONFIG.SOCKET_ID_LENGTH);
        document.getElementById("socketId").value = newId;
      }

      // ========================================
      // INITIALISATION AU CHARGEMENT
      // ========================================

      // Initialiser les valeurs par d√©faut et les options
      document.addEventListener("DOMContentLoaded", function () {
        initializeDefaultValues();
        updateColorOptions();
      });
    </script>
  </body>
</html>
